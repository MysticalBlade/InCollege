>>SOURCE FORMAT FREE
IDENTIFICATION DIVISION.
PROGRAM-ID. InCollege.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SOURCE-COMPUTER. GNUCOBOL.
OBJECT-COMPUTER. GNUCOBOL.

INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT USER-INPUT ASSIGN TO 'InCollege-Input.txt'
        ORGANIZATION IS LINE SEQUENTIAL.
    SELECT PROGRAM-OUTPUT ASSIGN TO 'InCollege-Output.txt'
        ORGANIZATION IS LINE SEQUENTIAL.
    SELECT USER-ACCOUNTS ASSIGN TO 'Accounts.dat'
        ORGANIZATION IS LINE SEQUENTIAL
        FILE STATUS IS ACCOUNT-FILE-STATUS.
    *> NEW: Profiles persistence
    SELECT USER-PROFILES ASSIGN TO 'Profiles.dat'
        ORGANIZATION IS LINE SEQUENTIAL
        FILE STATUS IS PROFILE-FILE-STATUS.

DATA DIVISION.
FILE SECTION.
FD  USER-INPUT.
01  INPUT-LINE                 PIC X(200).

FD  PROGRAM-OUTPUT.
01  OUTPUT-LINE                PIC X(200).

FD  USER-ACCOUNTS.
01  ACCOUNT-DATA.
    05  USER-NAME              PIC X(20).
    05  FILLER                 PIC X     VALUE '|'.
    05  USER-PASSWORD          PIC X(12).

*> NEW: Profiles file (one profile per line, '|' between fields, '^' between entries, '~' inside entry)
FD  USER-PROFILES.
01  PROFILE-REC                PIC X(500).

WORKING-STORAGE SECTION.
01  ACCOUNT-FILE-STATUS        PIC XX.
01  PROFILE-FILE-STATUS        PIC XX.
01  END-OF-FILE-FLAG           PIC X      VALUE 'N'.
    88  NO-MORE-DATA           VALUE 'Y'.

01  INPUT-BUFFER               PIC X(200) VALUE SPACES.
01  MESSAGE-BUFFER             PIC X(200) VALUE SPACES.

01  CREDENTIALS-VALID          PIC X      VALUE 'N'.
01  PASSWORD-VALID-FLAG        PIC X      VALUE 'N'.

01  MAXIMUM-ACCOUNTS           PIC 9      VALUE 5.
01  ACCOUNT-INFO.
    05  ACCOUNT-COUNT          PIC 9      VALUE 0.
    05  ACCOUNT-ENTRY OCCURS 5 TIMES.
       10  ACCT-USER           PIC X(20).
       10  ACCT-PASS           PIC X(12).

01  LOOP-INDEX                 PIC 99     VALUE 0.
01  SKILL-INDEX                PIC 99     VALUE 0.

01  CURRENT-USER               PIC X(20)  VALUE SPACES.
01  INPUT-USERNAME             PIC X(20)  VALUE SPACES.
01  INPUT-PASSWORD             PIC X(12)  VALUE SPACES.

01  PASS-LENGTH                PIC 99     VALUE 0.
01  CURRENT-CHAR               PIC X      VALUE SPACE.
01  CONTAINS-UPPERCASE         PIC X      VALUE 'N'.
01  CONTAINS-DIGIT             PIC X      VALUE 'N'.
01  CONTAINS-SPECIAL-CHAR      PIC X      VALUE 'N'.

01  NORMALIZED-INPUT           PIC X(200) VALUE SPACES.

01  AVAILABLE-SKILLS.
    05  SKILL-LIST OCCURS 5 TIMES PIC X(40) VALUE SPACES.

*> =====================
*> NEW: Profile structures (in-memory)
*> =====================
01  MAX-PROFILES               PIC 9 VALUE 5.
01  PROFILE-TABLE.
    05  PROFILE-COUNT          PIC 9 VALUE 0.
    05  PROFILE-ENTRY OCCURS 5 TIMES.
       10  P-USER              PIC X(20).
       10  P-FIRST             PIC X(20).
       10  P-LAST              PIC X(20).
       10  P-UNIV              PIC X(40).
       10  P-MAJOR             PIC X(40).
       10  P-GRAD              PIC X(4).
       10  P-ABOUT             PIC X(200).
       10  P-EXP-COUNT         PIC 9 VALUE 0.
       10  P-EXP OCCURS 3 TIMES.
           15  P-EXP-TITLE     PIC X(30).
           15  P-EXP-COMP      PIC X(30).
           15  P-EXP-DATES     PIC X(30).
           15  P-EXP-DESC      PIC X(100).
       10  P-EDU-COUNT         PIC 9 VALUE 0.
       10  P-EDU OCCURS 3 TIMES.
           15  P-EDU-DEG       PIC X(30).
           15  P-EDU-SCHOOL    PIC X(40).
           15  P-EDU-YEARS     PIC X(20).

*> Helpers for serialization/deserialization
01  SER-LINE                   PIC X(500).
01  TOK-USER                   PIC X(20).
01  TOK-FIRST                  PIC X(20).
01  TOK-LAST                   PIC X(20).
01  TOK-UNIV                   PIC X(40).
01  TOK-MAJOR                  PIC X(40).
01  TOK-GRAD                   PIC X(4).
01  TOK-ABOUT                  PIC X(200).
01  TOK-EXPCNT                 PIC 9.
01  TOK-EDUCNT                 PIC 9.
01  EXP-BLOCK                  PIC X(300).
01  EDU-BLOCK                  PIC X(300).
01  EXP1                       PIC X(120).
01  EXP2                       PIC X(120).
01  EXP3                       PIC X(120).
01  EDU1                       PIC X(120).
01  EDU2                       PIC X(120).
01  EDU3                       PIC X(120).
01  SUBI                       PIC 9 VALUE 0.
*> Pointers for STRING appends in serialization
01  EXP-PTR                    PIC 9(4) VALUE 1.
01  EDU-PTR                    PIC 9(4) VALUE 1.

01  YEAR-NUM                   PIC 9(4) VALUE 0.
01  PROFILE-IDX                PIC 9 VALUE 0.

PROCEDURE DIVISION.
000-MAIN.
    PERFORM 100-INITIALIZE-PROGRAM
    PERFORM 200-MAIN-LOOP UNTIL NO-MORE-DATA
    PERFORM 900-TERMINATE-PROGRAM
    STOP RUN.

100-INITIALIZE-PROGRAM.
    OPEN OUTPUT PROGRAM-OUTPUT
    OPEN INPUT  USER-INPUT

    OPEN INPUT USER-ACCOUNTS
    IF ACCOUNT-FILE-STATUS = "00"
        PERFORM FOREVER
            READ USER-ACCOUNTS
                AT END EXIT PERFORM
            END-READ
            IF USER-NAME NOT = SPACES
                ADD 1 TO ACCOUNT-COUNT
                MOVE USER-NAME TO ACCT-USER(ACCOUNT-COUNT)
                MOVE USER-PASSWORD TO ACCT-PASS(ACCOUNT-COUNT)
            END-IF
        END-PERFORM
        CLOSE USER-ACCOUNTS
    END-IF

    *> Initialize skills as "Skill 1" through "Skill 5" to match sample
    MOVE "Skill 1" TO SKILL-LIST(1)
    MOVE "Skill 2" TO SKILL-LIST(2)
    MOVE "Skill 3" TO SKILL-LIST(3)
    MOVE "Skill 4" TO SKILL-LIST(4)
    MOVE "Skill 5" TO SKILL-LIST(5)

    *> NEW: Load profiles from file, if present
    PERFORM 860-LOAD-PROFILES

    MOVE "Welcome to InCollege!" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE.

200-MAIN-LOOP.
    MOVE "Log In" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    MOVE "Create New Account" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    MOVE "Enter your choice:" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE

    PERFORM 600-GET-USER-INPUT
    IF NO-MORE-DATA
        EXIT PARAGRAPH
    END-IF

    MOVE FUNCTION UPPER-CASE(FUNCTION TRIM(INPUT-BUFFER))
      TO NORMALIZED-INPUT

    EVALUATE TRUE
       WHEN NORMALIZED-INPUT = "1"
           OR NORMALIZED-INPUT = "LOGIN"
           OR NORMALIZED-INPUT = "LOG IN"
               PERFORM 300-LOGIN-PROCESS

       WHEN NORMALIZED-INPUT = "2"
             OR NORMALIZED-INPUT = "CREATE NEW ACCOUNT"
             OR NORMALIZED-INPUT = "CREATE ACCOUNT"
             OR NORMALIZED-INPUT = "CREATE"
               PERFORM 400-CREATE-ACCOUNT-PROCESS

       WHEN OTHER
           CONTINUE
    END-EVALUATE.

300-LOGIN-PROCESS.
    PERFORM UNTIL NO-MORE-DATA
        MOVE "Please enter your username:" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA
            EXIT PARAGRAPH
        END-IF
        MOVE FUNCTION TRIM(INPUT-BUFFER) TO INPUT-USERNAME

        MOVE "Please enter your password:" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA
            EXIT PARAGRAPH
        END-IF
        MOVE FUNCTION TRIM(INPUT-BUFFER) TO INPUT-PASSWORD

        PERFORM 800-VERIFY-CREDENTIALS
        IF CREDENTIALS-VALID = 'Y'
            MOVE "You have successfully logged in." TO MESSAGE-BUFFER
            PERFORM 700-DISPLAY-MESSAGE
            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Welcome, "               DELIMITED BY SIZE
                   FUNCTION TRIM(INPUT-USERNAME) DELIMITED BY SIZE
                   "!"                       DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            MOVE FUNCTION TRIM(INPUT-USERNAME) TO CURRENT-USER

            PERFORM 500-POST-LOGIN-OPERATIONS
            EXIT PARAGRAPH
        ELSE
            MOVE "Incorrect username/password, please try again"
              TO MESSAGE-BUFFER
            PERFORM 700-DISPLAY-MESSAGE
        END-IF
    END-PERFORM.

400-CREATE-ACCOUNT-PROCESS.
    IF ACCOUNT-COUNT >= MAXIMUM-ACCOUNTS
        MOVE "All permitted accounts have been created, please come back later"
          TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        EXIT PARAGRAPH
    END-IF

    MOVE "Please enter your username:" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    PERFORM 600-GET-USER-INPUT
    IF NO-MORE-DATA
        EXIT PARAGRAPH
    END-IF
    MOVE FUNCTION TRIM(INPUT-BUFFER) TO INPUT-USERNAME

    COMPUTE PASS-LENGTH =
        FUNCTION LENGTH(FUNCTION TRIM(INPUT-USERNAME))
    IF PASS-LENGTH > 20
        MOVE "Username too long (max 20)." TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        EXIT PARAGRAPH
    END-IF

    MOVE 'N' TO CREDENTIALS-VALID
    PERFORM VARYING LOOP-INDEX FROM 1 BY 1
      UNTIL LOOP-INDEX > ACCOUNT-COUNT
        IF INPUT-USERNAME = FUNCTION TRIM(ACCT-USER(LOOP-INDEX))
            MOVE "Username already exists, please try again."
              TO MESSAGE-BUFFER
            PERFORM 700-DISPLAY-MESSAGE
            EXIT PARAGRAPH
        END-IF
    END-PERFORM

    MOVE "Please enter your password:" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    PERFORM 600-GET-USER-INPUT
    IF NO-MORE-DATA
        EXIT PARAGRAPH
    END-IF
    MOVE FUNCTION TRIM(INPUT-BUFFER) TO INPUT-PASSWORD

    PERFORM 810-VALIDATE-PASSWORD
    IF PASSWORD-VALID-FLAG NOT = 'Y'
        MOVE "Invalid password. Password must be 8-12 characters and include at least one capital letter, one digit, and one special character."
          TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        EXIT PARAGRAPH
    END-IF

    ADD 1 TO ACCOUNT-COUNT
    MOVE INPUT-USERNAME TO ACCT-USER(ACCOUNT-COUNT)
    MOVE INPUT-PASSWORD TO ACCT-PASS(ACCOUNT-COUNT)
    MOVE "Account created successfully." TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE.

*> =====================
*> UPDATED: Post-login menu to include Profile features
*> =====================
500-POST-LOGIN-OPERATIONS.
    PERFORM UNTIL NO-MORE-DATA
        MOVE "Search for a job" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        MOVE "Find someone you know" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        MOVE "Learn a new skill" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        MOVE "Create/Edit My Profile" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        MOVE "View My Profile" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        MOVE "Enter your choice:" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE

        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA
            EXIT PARAGRAPH
        END-IF
        MOVE FUNCTION UPPER-CASE(FUNCTION TRIM(INPUT-BUFFER))
          TO NORMALIZED-INPUT

        EVALUATE TRUE
           WHEN NORMALIZED-INPUT = "1"
             OR NORMALIZED-INPUT = "SEARCH FOR A JOB"
             OR NORMALIZED-INPUT = "SEARCH JOB"
             OR NORMALIZED-INPUT = "SEARCH"
               MOVE "Job search/internship is under construction." TO MESSAGE-BUFFER
               PERFORM 700-DISPLAY-MESSAGE

           WHEN NORMALIZED-INPUT = "2"
             OR NORMALIZED-INPUT = "FIND SOMEONE YOU KNOW"
             OR NORMALIZED-INPUT = "FIND USER"
             OR NORMALIZED-INPUT = "FIND"
               PERFORM 570-SEARCH-AND-DISPLAY-PROFILE

           WHEN NORMALIZED-INPUT = "3"
             OR NORMALIZED-INPUT = "LEARN A NEW SKILL"
             OR NORMALIZED-INPUT = "LEARN"
               PERFORM 550-SKILLS-MODULE

           WHEN NORMALIZED-INPUT = "4"
             OR NORMALIZED-INPUT = "CREATE/EDIT MY PROFILE"
             OR NORMALIZED-INPUT = "CREATE PROFILE"
             OR NORMALIZED-INPUT = "EDIT PROFILE"
               PERFORM 560-CREATE-OR-EDIT-PROFILE

           WHEN NORMALIZED-INPUT = "5"
             OR NORMALIZED-INPUT = "VIEW MY PROFILE"
             OR NORMALIZED-INPUT = "VIEW PROFILE"
               PERFORM 565-VIEW-MY-PROFILE

           WHEN OTHER
               CONTINUE
        END-EVALUATE
    END-PERFORM.

570-SEARCH-AND-DISPLAY-PROFILE.
    MOVE "Enter the full name of the person you are looking for:" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    PERFORM 600-GET-USER-INPUT
    IF NO-MORE-DATA EXIT PARAGRAPH END-IF
    MOVE FUNCTION TRIM(INPUT-BUFFER) TO INPUT-USERNAME

    MOVE 0 TO PROFILE-IDX
    PERFORM VARYING LOOP-INDEX FROM 1 BY 1 UNTIL LOOP-INDEX > PROFILE-COUNT
        MOVE SPACES TO MESSAGE-BUFFER
        MOVE SPACES TO INPUT-BUFFER
        *> Build full name from stored profile
        MOVE SPACES TO MESSAGE-BUFFER
        STRING FUNCTION TRIM(P-FIRST(LOOP-INDEX)) DELIMITED BY SIZE
               " " DELIMITED BY SIZE
               FUNCTION TRIM(P-LAST(LOOP-INDEX)) DELIMITED BY SIZE
          INTO SER-LINE
        END-STRING
        IF FUNCTION UPPER-CASE(FUNCTION TRIM(INPUT-USERNAME)) =
           FUNCTION UPPER-CASE(FUNCTION TRIM(SER-LINE))
            MOVE LOOP-INDEX TO PROFILE-IDX
            EXIT PERFORM
        END-IF
    END-PERFORM

    IF PROFILE-IDX = 0
        MOVE "No one by that name could be found." TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        EXIT PARAGRAPH
    END-IF

    MOVE "--- Found User Profile ---" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE

    MOVE SPACES TO MESSAGE-BUFFER
    STRING "Name: " DELIMITED BY SIZE
           FUNCTION TRIM(P-FIRST(PROFILE-IDX)) DELIMITED BY SIZE
           " " DELIMITED BY SIZE
           FUNCTION TRIM(P-LAST(PROFILE-IDX)) DELIMITED BY SIZE
      INTO MESSAGE-BUFFER
    END-STRING
    PERFORM 700-DISPLAY-MESSAGE

    MOVE SPACES TO MESSAGE-BUFFER
    STRING "University: " DELIMITED BY SIZE
           FUNCTION TRIM(P-UNIV(PROFILE-IDX)) DELIMITED BY SIZE
      INTO MESSAGE-BUFFER
    END-STRING
    PERFORM 700-DISPLAY-MESSAGE

    MOVE SPACES TO MESSAGE-BUFFER
    STRING "Major: " DELIMITED BY SIZE
           FUNCTION TRIM(P-MAJOR(PROFILE-IDX)) DELIMITED BY SIZE
      INTO MESSAGE-BUFFER
    END-STRING
    PERFORM 700-DISPLAY-MESSAGE

    MOVE SPACES TO MESSAGE-BUFFER
    STRING "Graduation Year: " DELIMITED BY SIZE
           FUNCTION TRIM(P-GRAD(PROFILE-IDX)) DELIMITED BY SIZE
      INTO MESSAGE-BUFFER
    END-STRING
    PERFORM 700-DISPLAY-MESSAGE

    IF FUNCTION TRIM(P-ABOUT(PROFILE-IDX)) NOT = SPACES
        MOVE SPACES TO MESSAGE-BUFFER
        STRING "About Me: " DELIMITED BY SIZE
               FUNCTION TRIM(P-ABOUT(PROFILE-IDX)) DELIMITED BY SIZE
          INTO MESSAGE-BUFFER
        END-STRING
        PERFORM 700-DISPLAY-MESSAGE
    END-IF

    MOVE "Experience:" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    IF P-EXP-COUNT(PROFILE-IDX) > 0
        PERFORM VARYING SUBI FROM 1 BY 1 UNTIL SUBI > P-EXP-COUNT(PROFILE-IDX)
            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Title: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EXP-TITLE(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Company: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EXP-COMP(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Dates: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EXP-DATES(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            IF FUNCTION TRIM(P-EXP-DESC(PROFILE-IDX SUBI)) NOT = SPACES
                MOVE SPACES TO MESSAGE-BUFFER
                STRING "Description: " DELIMITED BY SIZE
                       FUNCTION TRIM(P-EXP-DESC(PROFILE-IDX SUBI)) DELIMITED BY SIZE
                  INTO MESSAGE-BUFFER
                END-STRING
                PERFORM 700-DISPLAY-MESSAGE
            END-IF
        END-PERFORM
    ELSE
        MOVE "Experience: None" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
    END-IF

    MOVE "Education:" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    IF P-EDU-COUNT(PROFILE-IDX) > 0
        PERFORM VARYING SUBI FROM 1 BY 1 UNTIL SUBI > P-EDU-COUNT(PROFILE-IDX)
            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Degree: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EDU-DEG(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            MOVE SPACES TO MESSAGE-BUFFER
            STRING "University: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EDU-SCHOOL(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Years: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EDU-YEARS(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE
        END-PERFORM
    ELSE
        MOVE "Education: None" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
    END-IF

    MOVE "--------------------" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE.

550-SKILLS-MODULE.
    PERFORM UNTIL NO-MORE-DATA
        *> Skills menu format to match sample output
        MOVE "Learn a New Skill:" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE

        *> Display Skill 1 through Skill 5
        PERFORM VARYING SKILL-INDEX FROM 1 BY 1
          UNTIL SKILL-INDEX > 5
            MOVE SKILL-LIST(SKILL-INDEX) TO MESSAGE-BUFFER
            PERFORM 700-DISPLAY-MESSAGE
        END-PERFORM

        MOVE "Go Back" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        MOVE "Enter your choice:" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE

        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA
            EXIT PARAGRAPH
        END-IF
        MOVE FUNCTION UPPER-CASE(FUNCTION TRIM(INPUT-BUFFER))
          TO NORMALIZED-INPUT

        IF NORMALIZED-INPUT = "GO BACK"
           OR NORMALIZED-INPUT = "BACK"
           OR NORMALIZED-INPUT = "0"
            EXIT PARAGRAPH
        ELSE
            MOVE 0 TO LOOP-INDEX
            IF NORMALIZED-INPUT >= "1" AND NORMALIZED-INPUT <= "5"
                MOVE FUNCTION NUMVAL(NORMALIZED-INPUT) TO LOOP-INDEX
            ELSE
                PERFORM VARYING SKILL-INDEX FROM 1 BY 1
                  UNTIL SKILL-INDEX > 5
                   IF NORMALIZED-INPUT = FUNCTION UPPER-CASE(
                      FUNCTION TRIM(SKILL-LIST(SKILL-INDEX)))
                      MOVE SKILL-INDEX TO LOOP-INDEX
                      EXIT PERFORM
                   END-IF
                END-PERFORM
            END-IF

            IF LOOP-INDEX >= 1 AND LOOP-INDEX <= 5
                MOVE "This skill is under construction." TO MESSAGE-BUFFER
                PERFORM 700-DISPLAY-MESSAGE
            END-IF
        END-IF
    END-PERFORM.

*> =====================
*> NEW: Profile creation / editing
*> =====================
560-CREATE-OR-EDIT-PROFILE.
    PERFORM 820-FIND-OR-CREATE-PROFILE-INDEX
    IF PROFILE-IDX = 0
        MOVE "Unable to create profile at this time." TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        EXIT PARAGRAPH
    END-IF

    MOVE "--- Create/Edit Profile ---" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE

    *> First Name (Required)
    MOVE "Enter First Name:" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    PERFORM 600-GET-USER-INPUT
    IF NO-MORE-DATA EXIT PARAGRAPH END-IF
    MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-FIRST(PROFILE-IDX)

    *> Last Name (Required)
    MOVE "Enter Last Name:" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    PERFORM 600-GET-USER-INPUT
    IF NO-MORE-DATA EXIT PARAGRAPH END-IF
    MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-LAST(PROFILE-IDX)

    *> University (Required)
    MOVE "Enter University/College Attended:" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    PERFORM 600-GET-USER-INPUT
    IF NO-MORE-DATA EXIT PARAGRAPH END-IF
    MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-UNIV(PROFILE-IDX)

    *> Major (Required)
    MOVE "Enter Major:" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    PERFORM 600-GET-USER-INPUT
    IF NO-MORE-DATA EXIT PARAGRAPH END-IF
    MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-MAJOR(PROFILE-IDX)

    *> Graduation Year (Required, validated)
    MOVE "Enter Graduation Year (YYYY):" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    PERFORM 600-GET-USER-INPUT
    IF NO-MORE-DATA EXIT PARAGRAPH END-IF
    MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-GRAD(PROFILE-IDX)

    IF FUNCTION LENGTH(FUNCTION TRIM(P-GRAD(PROFILE-IDX))) NOT = 4
        MOVE "Invalid graduation year length." TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        EXIT PARAGRAPH
    END-IF
    COMPUTE YEAR-NUM = FUNCTION NUMVAL(P-GRAD(PROFILE-IDX))
    IF YEAR-NUM < 1900 OR YEAR-NUM > 2100
        MOVE "Invalid graduation year range." TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        EXIT PARAGRAPH
    END-IF

    *> About Me (Optional)
    MOVE "Enter About Me (optional, max 200 chars, enter blank line to skip):" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE
    PERFORM 600-GET-USER-INPUT
    IF NO-MORE-DATA EXIT PARAGRAPH END-IF
    IF FUNCTION TRIM(INPUT-BUFFER) = SPACES
        CONTINUE
    ELSE
        MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-ABOUT(PROFILE-IDX)
    END-IF

    *> Experience (Optional, up to 3)
    MOVE 0 TO P-EXP-COUNT(PROFILE-IDX)
    PERFORM VARYING SUBI FROM 1 BY 1 UNTIL SUBI > 3
        MOVE "Add Experience (optional, max 3 entries. Enter 'DONE' to finish):" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA EXIT PERFORM END-IF
        MOVE FUNCTION UPPER-CASE(FUNCTION TRIM(INPUT-BUFFER)) TO NORMALIZED-INPUT
        IF NORMALIZED-INPUT = "DONE"
            EXIT PERFORM
        END-IF
        ADD 1 TO P-EXP-COUNT(PROFILE-IDX)
        MOVE "Experience #" TO MESSAGE-BUFFER
        STRING "Experience #" DELIMITED BY SIZE
               FUNCTION TRIM(FUNCTION NUMVAL-C(SUBI)) DELIMITED BY SIZE
               " - Title:" DELIMITED BY SIZE INTO MESSAGE-BUFFER
        END-STRING
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA EXIT PERFORM END-IF
        MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-EXP-TITLE(PROFILE-IDX SUBI)

        MOVE "Experience #" TO MESSAGE-BUFFER
        STRING "Experience #" DELIMITED BY SIZE
               FUNCTION TRIM(FUNCTION NUMVAL-C(SUBI)) DELIMITED BY SIZE
               " - Company/Organization:" DELIMITED BY SIZE INTO MESSAGE-BUFFER
        END-STRING
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA EXIT PERFORM END-IF
        MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-EXP-COMP(PROFILE-IDX SUBI)

        MOVE "Experience #" TO MESSAGE-BUFFER
        STRING "Experience #" DELIMITED BY SIZE
               FUNCTION TRIM(FUNCTION NUMVAL-C(SUBI)) DELIMITED BY SIZE
               " - Dates (e.g., Summer 2024):" DELIMITED BY SIZE INTO MESSAGE-BUFFER
        END-STRING
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA EXIT PERFORM END-IF
        MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-EXP-DATES(PROFILE-IDX SUBI)

        MOVE "Experience #" TO MESSAGE-BUFFER
        STRING "Experience #" DELIMITED BY SIZE
               FUNCTION TRIM(FUNCTION NUMVAL-C(SUBI)) DELIMITED BY SIZE
               " - Description (optional, max 100 chars, blank to skip):" DELIMITED BY SIZE INTO MESSAGE-BUFFER
        END-STRING
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA EXIT PERFORM END-IF
        IF FUNCTION TRIM(INPUT-BUFFER) NOT = SPACES
            MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-EXP-DESC(PROFILE-IDX SUBI)
        END-IF
    END-PERFORM

    *> Education (Optional, up to 3)
    MOVE 0 TO P-EDU-COUNT(PROFILE-IDX)
    PERFORM VARYING SUBI FROM 1 BY 1 UNTIL SUBI > 3
        MOVE "Add Education (optional, max 3 entries. Enter 'DONE' to finish):" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA EXIT PERFORM END-IF
        MOVE FUNCTION UPPER-CASE(FUNCTION TRIM(INPUT-BUFFER)) TO NORMALIZED-INPUT
        IF NORMALIZED-INPUT = "DONE"
            EXIT PERFORM
        END-IF
        ADD 1 TO P-EDU-COUNT(PROFILE-IDX)
        MOVE "Education #" TO MESSAGE-BUFFER
        STRING "Education #" DELIMITED BY SIZE
               FUNCTION TRIM(FUNCTION NUMVAL-C(SUBI)) DELIMITED BY SIZE
               " - Degree:" DELIMITED BY SIZE INTO MESSAGE-BUFFER
        END-STRING
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA EXIT PERFORM END-IF
        MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-EDU-DEG(PROFILE-IDX SUBI)

        MOVE "Education #" TO MESSAGE-BUFFER
        STRING "Education #" DELIMITED BY SIZE
               FUNCTION TRIM(FUNCTION NUMVAL-C(SUBI)) DELIMITED BY SIZE
               " - University/College:" DELIMITED BY SIZE INTO MESSAGE-BUFFER
        END-STRING
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA EXIT PERFORM END-IF
        MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-EDU-SCHOOL(PROFILE-IDX SUBI)

        MOVE "Education #" TO MESSAGE-BUFFER
        STRING "Education #" DELIMITED BY SIZE
               FUNCTION TRIM(FUNCTION NUMVAL-C(SUBI)) DELIMITED BY SIZE
               " - Years Attended (e.g., 2023-2025):" DELIMITED BY SIZE INTO MESSAGE-BUFFER
        END-STRING
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM 600-GET-USER-INPUT
        IF NO-MORE-DATA EXIT PERFORM END-IF
        MOVE FUNCTION TRIM(INPUT-BUFFER) TO P-EDU-YEARS(PROFILE-IDX SUBI)
    END-PERFORM

    MOVE "Profile saved successfully!" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE

    *> Save to disk immediately so it persists even if program ends early
    PERFORM 870-SAVE-PROFILES.

*> =====================
*> NEW: View profile
*> =====================
565-VIEW-MY-PROFILE.
    PERFORM 821-FIND-PROFILE-INDEX-ONLY
    IF PROFILE-IDX = 0
        MOVE "No profile found. Use 'Create/Edit My Profile' first." TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        EXIT PARAGRAPH
    END-IF

    MOVE "--- Your Profile ---" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE

    MOVE SPACES TO MESSAGE-BUFFER
    STRING "Name: " DELIMITED BY SIZE
           FUNCTION TRIM(P-FIRST(PROFILE-IDX)) DELIMITED BY SIZE
           " " DELIMITED BY SIZE
           FUNCTION TRIM(P-LAST(PROFILE-IDX)) DELIMITED BY SIZE
      INTO MESSAGE-BUFFER
    END-STRING
    PERFORM 700-DISPLAY-MESSAGE

    MOVE SPACES TO MESSAGE-BUFFER
    STRING "University: " DELIMITED BY SIZE
           FUNCTION TRIM(P-UNIV(PROFILE-IDX)) DELIMITED BY SIZE
      INTO MESSAGE-BUFFER
    END-STRING
    PERFORM 700-DISPLAY-MESSAGE

    MOVE SPACES TO MESSAGE-BUFFER
    STRING "Major: " DELIMITED BY SIZE
           FUNCTION TRIM(P-MAJOR(PROFILE-IDX)) DELIMITED BY SIZE
      INTO MESSAGE-BUFFER
    END-STRING
    PERFORM 700-DISPLAY-MESSAGE

    MOVE SPACES TO MESSAGE-BUFFER
    STRING "Graduation Year: " DELIMITED BY SIZE
           FUNCTION TRIM(P-GRAD(PROFILE-IDX)) DELIMITED BY SIZE
      INTO MESSAGE-BUFFER
    END-STRING
    PERFORM 700-DISPLAY-MESSAGE

    IF FUNCTION TRIM(P-ABOUT(PROFILE-IDX)) NOT = SPACES
        MOVE SPACES TO MESSAGE-BUFFER
        STRING "About Me: " DELIMITED BY SIZE
               FUNCTION TRIM(P-ABOUT(PROFILE-IDX)) DELIMITED BY SIZE
          INTO MESSAGE-BUFFER
        END-STRING
        PERFORM 700-DISPLAY-MESSAGE
    END-IF

    IF P-EXP-COUNT(PROFILE-IDX) > 0
        MOVE "Experience:" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM VARYING SUBI FROM 1 BY 1 UNTIL SUBI > P-EXP-COUNT(PROFILE-IDX)
            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Title: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EXP-TITLE(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Company: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EXP-COMP(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Dates: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EXP-DATES(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            IF FUNCTION TRIM(P-EXP-DESC(PROFILE-IDX SUBI)) NOT = SPACES
                MOVE SPACES TO MESSAGE-BUFFER
                STRING "Description: " DELIMITED BY SIZE
                       FUNCTION TRIM(P-EXP-DESC(PROFILE-IDX SUBI)) DELIMITED BY SIZE
                  INTO MESSAGE-BUFFER
                END-STRING
                PERFORM 700-DISPLAY-MESSAGE
            END-IF
        END-PERFORM
    END-IF

    IF P-EDU-COUNT(PROFILE-IDX) > 0
        MOVE "Education:" TO MESSAGE-BUFFER
        PERFORM 700-DISPLAY-MESSAGE
        PERFORM VARYING SUBI FROM 1 BY 1 UNTIL SUBI > P-EDU-COUNT(PROFILE-IDX)
            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Degree: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EDU-DEG(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            MOVE SPACES TO MESSAGE-BUFFER
            STRING "University: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EDU-SCHOOL(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE

            MOVE SPACES TO MESSAGE-BUFFER
            STRING "Years: " DELIMITED BY SIZE
                   FUNCTION TRIM(P-EDU-YEARS(PROFILE-IDX SUBI)) DELIMITED BY SIZE
              INTO MESSAGE-BUFFER
            END-STRING
            PERFORM 700-DISPLAY-MESSAGE
        END-PERFORM
    END-IF

    MOVE "--------------------" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE.

600-GET-USER-INPUT.
    READ USER-INPUT
        AT END
            SET NO-MORE-DATA TO TRUE
        NOT AT END
            MOVE FUNCTION TRIM(INPUT-LINE) TO INPUT-BUFFER
    END-READ.

700-DISPLAY-MESSAGE.
    MOVE SPACES TO OUTPUT-LINE
    MOVE FUNCTION TRIM(MESSAGE-BUFFER) TO OUTPUT-LINE
    DISPLAY FUNCTION TRIM(MESSAGE-BUFFER)
    WRITE OUTPUT-LINE.


800-VERIFY-CREDENTIALS.
    MOVE 'N' TO CREDENTIALS-VALID
    PERFORM VARYING LOOP-INDEX FROM 1 BY 1
      UNTIL LOOP-INDEX > ACCOUNT-COUNT
        IF INPUT-USERNAME = FUNCTION TRIM(ACCT-USER(LOOP-INDEX))
           AND INPUT-PASSWORD = FUNCTION TRIM(ACCT-PASS(LOOP-INDEX))
           MOVE 'Y' TO CREDENTIALS-VALID
           EXIT PERFORM
        END-IF
    END-PERFORM.

810-VALIDATE-PASSWORD.
    MOVE 0 TO PASS-LENGTH
    MOVE 'N' TO CONTAINS-UPPERCASE
    MOVE 'N' TO CONTAINS-DIGIT
    MOVE 'N' TO CONTAINS-SPECIAL-CHAR

    COMPUTE PASS-LENGTH =
        FUNCTION LENGTH(FUNCTION TRIM(INPUT-PASSWORD))
    IF PASS-LENGTH < 8 OR PASS-LENGTH > 12
        MOVE 'N' TO PASSWORD-VALID-FLAG
        EXIT PARAGRAPH
    END-IF

    PERFORM VARYING LOOP-INDEX FROM 1 BY 1
      UNTIL LOOP-INDEX > PASS-LENGTH
        MOVE INPUT-PASSWORD(LOOP-INDEX:1) TO CURRENT-CHAR

        IF CURRENT-CHAR IS NUMERIC
            MOVE 'Y' TO CONTAINS-DIGIT
        END-IF
        IF CURRENT-CHAR IS ALPHABETIC AND
           CURRENT-CHAR = FUNCTION UPPER-CASE(CURRENT-CHAR)
            MOVE 'Y' TO CONTAINS-UPPERCASE
        END-IF
        IF CURRENT-CHAR NOT ALPHABETIC AND
           CURRENT-CHAR NOT NUMERIC AND
           CURRENT-CHAR NOT = SPACE
            MOVE 'Y' TO CONTAINS-SPECIAL-CHAR
        END-IF
    END-PERFORM

    IF CONTAINS-UPPERCASE = 'Y' AND
       CONTAINS-DIGIT = 'Y' AND
       CONTAINS-SPECIAL-CHAR = 'Y'
        MOVE 'Y' TO PASSWORD-VALID-FLAG
    ELSE
        MOVE 'N' TO PASSWORD-VALID-FLAG
    END-IF.

*> =====================
*> NEW: Profile index helpers
*> =====================
820-FIND-OR-CREATE-PROFILE-INDEX.
    MOVE 0 TO PROFILE-IDX
    PERFORM VARYING LOOP-INDEX FROM 1 BY 1 UNTIL LOOP-INDEX > PROFILE-COUNT
        IF CURRENT-USER = FUNCTION TRIM(P-USER(LOOP-INDEX))
            MOVE LOOP-INDEX TO PROFILE-IDX
            EXIT PERFORM
        END-IF
    END-PERFORM
    IF PROFILE-IDX = 0
        IF PROFILE-COUNT < MAX-PROFILES
            ADD 1 TO PROFILE-COUNT
            MOVE PROFILE-COUNT TO PROFILE-IDX
            MOVE FUNCTION TRIM(CURRENT-USER) TO P-USER(PROFILE-IDX)
            *> Reset counts on new profile
            MOVE 0 TO P-EXP-COUNT(PROFILE-IDX)
            MOVE 0 TO P-EDU-COUNT(PROFILE-IDX)
        ELSE
            MOVE 0 TO PROFILE-IDX
        END-IF
    END-IF.

821-FIND-PROFILE-INDEX-ONLY.
    MOVE 0 TO PROFILE-IDX
    PERFORM VARYING LOOP-INDEX FROM 1 BY 1 UNTIL LOOP-INDEX > PROFILE-COUNT
        IF CURRENT-USER = FUNCTION TRIM(P-USER(LOOP-INDEX))
            MOVE LOOP-INDEX TO PROFILE-IDX
            EXIT PERFORM
        END-IF
    END-PERFORM.

*> =====================
*> NEW: Persistence (load/save)
*> =====================
860-LOAD-PROFILES.
    OPEN INPUT USER-PROFILES
    IF PROFILE-FILE-STATUS = "00"
        PERFORM FOREVER
            READ USER-PROFILES
                AT END EXIT PERFORM
            END-READ
            IF FUNCTION TRIM(PROFILE-REC) NOT = SPACES
                IF PROFILE-COUNT < MAX-PROFILES
                    ADD 1 TO PROFILE-COUNT
                    PERFORM 830-DESERIALIZE-PROFILE
                END-IF
            END-IF
        END-PERFORM
        CLOSE USER-PROFILES
    END-IF.

870-SAVE-PROFILES.
    OPEN OUTPUT USER-PROFILES
    PERFORM VARYING LOOP-INDEX FROM 1 BY 1 UNTIL LOOP-INDEX > PROFILE-COUNT
        PERFORM 835-SERIALIZE-PROFILE
        WRITE PROFILE-REC FROM SER-LINE
    END-PERFORM
    CLOSE USER-PROFILES.

830-DESERIALIZE-PROFILE.
    *> PROFILE-REC: user|first|last|univ|major|grad|about|expCount|eduCount|expBlock|eduBlock
    MOVE SPACES TO TOK-USER TOK-FIRST TOK-LAST TOK-UNIV TOK-MAJOR TOK-GRAD TOK-ABOUT
    MOVE SPACES TO EXP-BLOCK EDU-BLOCK
    MOVE 0 TO TOK-EXPCNT TOK-EDUCNT

    UNSTRING PROFILE-REC DELIMITED BY ALL "|"
        INTO TOK-USER
             TOK-FIRST
             TOK-LAST
             TOK-UNIV
             TOK-MAJOR
             TOK-GRAD
             TOK-ABOUT
             TOK-EXPCNT
             TOK-EDUCNT
             EXP-BLOCK
             EDU-BLOCK
    END-UNSTRING

    MOVE FUNCTION TRIM(TOK-USER)  TO P-USER(PROFILE-COUNT)
    MOVE FUNCTION TRIM(TOK-FIRST) TO P-FIRST(PROFILE-COUNT)
    MOVE FUNCTION TRIM(TOK-LAST)  TO P-LAST(PROFILE-COUNT)
    MOVE FUNCTION TRIM(TOK-UNIV)  TO P-UNIV(PROFILE-COUNT)
    MOVE FUNCTION TRIM(TOK-MAJOR) TO P-MAJOR(PROFILE-COUNT)
    MOVE FUNCTION TRIM(TOK-GRAD)  TO P-GRAD(PROFILE-COUNT)
    MOVE FUNCTION TRIM(TOK-ABOUT) TO P-ABOUT(PROFILE-COUNT)

    MOVE TOK-EXPCNT TO P-EXP-COUNT(PROFILE-COUNT)
    MOVE TOK-EDUCNT TO P-EDU-COUNT(PROFILE-COUNT)

    MOVE SPACES TO EXP1 EXP2 EXP3
    UNSTRING EXP-BLOCK DELIMITED BY "^"
        INTO EXP1 EXP2 EXP3
    END-UNSTRING

    PERFORM VARYING SUBI FROM 1 BY 1 UNTIL SUBI > P-EXP-COUNT(PROFILE-COUNT)
        EVALUATE SUBI
           WHEN 1 MOVE EXP1 TO SER-LINE
           WHEN 2 MOVE EXP2 TO SER-LINE
           WHEN 3 MOVE EXP3 TO SER-LINE
        END-EVALUATE
        MOVE SPACES TO TOK-FIRST TOK-LAST TOK-UNIV TOK-MAJOR
        UNSTRING SER-LINE DELIMITED BY "~"
            INTO P-EXP-TITLE(PROFILE-COUNT SUBI)
                 P-EXP-COMP(PROFILE-COUNT SUBI)
                 P-EXP-DATES(PROFILE-COUNT SUBI)
                 P-EXP-DESC(PROFILE-COUNT SUBI)
        END-UNSTRING
    END-PERFORM

    MOVE SPACES TO EDU1 EDU2 EDU3
    UNSTRING EDU-BLOCK DELIMITED BY "^"
        INTO EDU1 EDU2 EDU3
    END-UNSTRING

    PERFORM VARYING SUBI FROM 1 BY 1 UNTIL SUBI > P-EDU-COUNT(PROFILE-COUNT)
        EVALUATE SUBI
           WHEN 1 MOVE EDU1 TO SER-LINE
           WHEN 2 MOVE EDU2 TO SER-LINE
           WHEN 3 MOVE EDU3 TO SER-LINE
        END-EVALUATE
        UNSTRING SER-LINE DELIMITED BY "~"
            INTO P-EDU-DEG(PROFILE-COUNT SUBI)
                 P-EDU-SCHOOL(PROFILE-COUNT SUBI)
                 P-EDU-YEARS(PROFILE-COUNT SUBI)
        END-UNSTRING
    END-PERFORM.

835-SERIALIZE-PROFILE.
    MOVE SPACES TO SER-LINE

    *> Build EXP-BLOCK safely using explicit pointers
    MOVE SPACES TO EXP-BLOCK
    MOVE 1 TO EXP-PTR
    IF P-EXP-COUNT(LOOP-INDEX) > 0
        PERFORM VARYING SUBI FROM 1 BY 1 UNTIL SUBI > P-EXP-COUNT(LOOP-INDEX)
            IF SUBI > 1
                STRING "^" DELIMITED BY SIZE
                  INTO EXP-BLOCK WITH POINTER EXP-PTR
                END-STRING
            END-IF
            STRING FUNCTION TRIM(P-EXP-TITLE(LOOP-INDEX SUBI)) DELIMITED BY SIZE
                   "~" DELIMITED BY SIZE
                   FUNCTION TRIM(P-EXP-COMP(LOOP-INDEX SUBI))  DELIMITED BY SIZE
                   "~" DELIMITED BY SIZE
                   FUNCTION TRIM(P-EXP-DATES(LOOP-INDEX SUBI)) DELIMITED BY SIZE
                   "~" DELIMITED BY SIZE
                   FUNCTION TRIM(P-EXP-DESC(LOOP-INDEX SUBI))  DELIMITED BY SIZE
              INTO EXP-BLOCK WITH POINTER EXP-PTR
            END-STRING
        END-PERFORM
    END-IF

    *> Build EDU-BLOCK safely using explicit pointers
    MOVE SPACES TO EDU-BLOCK
    MOVE 1 TO EDU-PTR
    IF P-EDU-COUNT(LOOP-INDEX) > 0
        PERFORM VARYING SUBI FROM 1 BY 1 UNTIL SUBI > P-EDU-COUNT(LOOP-INDEX)
            IF SUBI > 1
                STRING "^" DELIMITED BY SIZE
                  INTO EDU-BLOCK WITH POINTER EDU-PTR
                END-STRING
            END-IF
            STRING FUNCTION TRIM(P-EDU-DEG(LOOP-INDEX SUBI))    DELIMITED BY SIZE
                   "~" DELIMITED BY SIZE
                   FUNCTION TRIM(P-EDU-SCHOOL(LOOP-INDEX SUBI)) DELIMITED BY SIZE
                   "~" DELIMITED BY SIZE
                   FUNCTION TRIM(P-EDU-YEARS(LOOP-INDEX SUBI))  DELIMITED BY SIZE
              INTO EDU-BLOCK WITH POINTER EDU-PTR
            END-STRING
        END-PERFORM
    END-IF

    *> Assemble full line: user|first|last|univ|major|grad|about|expCnt|eduCnt|expBlock|eduBlock
    MOVE SPACES TO SER-LINE
    STRING FUNCTION TRIM(P-USER(LOOP-INDEX))  DELIMITED BY SIZE
           "|" DELIMITED BY SIZE
           FUNCTION TRIM(P-FIRST(LOOP-INDEX)) DELIMITED BY SIZE
           "|" DELIMITED BY SIZE
           FUNCTION TRIM(P-LAST(LOOP-INDEX))  DELIMITED BY SIZE
           "|" DELIMITED BY SIZE
           FUNCTION TRIM(P-UNIV(LOOP-INDEX))  DELIMITED BY SIZE
           "|" DELIMITED BY SIZE
           FUNCTION TRIM(P-MAJOR(LOOP-INDEX)) DELIMITED BY SIZE
           "|" DELIMITED BY SIZE
           FUNCTION TRIM(P-GRAD(LOOP-INDEX))  DELIMITED BY SIZE
           "|" DELIMITED BY SIZE
           FUNCTION TRIM(P-ABOUT(LOOP-INDEX)) DELIMITED BY SIZE
           "|" DELIMITED BY SIZE
           P-EXP-COUNT(LOOP-INDEX)            DELIMITED BY SIZE
           "|" DELIMITED BY SIZE
           P-EDU-COUNT(LOOP-INDEX)            DELIMITED BY SIZE
           "|" DELIMITED BY SIZE
           EXP-BLOCK                           DELIMITED BY SIZE
           "|" DELIMITED BY SIZE
           EDU-BLOCK                           DELIMITED BY SIZE
      INTO SER-LINE
    END-STRING.

900-TERMINATE-PROGRAM.
    OPEN OUTPUT USER-ACCOUNTS
    PERFORM VARYING LOOP-INDEX FROM 1 BY 1
      UNTIL LOOP-INDEX > ACCOUNT-COUNT
        MOVE ACCT-USER(LOOP-INDEX) TO USER-NAME
        MOVE ACCT-PASS(LOOP-INDEX) TO USER-PASSWORD
        WRITE ACCOUNT-DATA
    END-PERFORM
    CLOSE USER-ACCOUNTS

    *> Save profiles on exit as well
    PERFORM 870-SAVE-PROFILES

    MOVE "--- END_OF_PROGRAM_EXECUTION ---" TO MESSAGE-BUFFER
    PERFORM 700-DISPLAY-MESSAGE

    CLOSE PROGRAM-OUTPUT
    CLOSE USER-INPUT.
